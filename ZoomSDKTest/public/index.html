<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zoom Local SDK Test (5.1.0)</title>
  <!-- CSS Dependencies -->
  <link rel="stylesheet" href="/sdk/css/bootstrap.css" />
  <link rel="stylesheet" href="/sdk/css/react-select.css" />

  <style>
    body {
      margin: 20px;
      font-family: sans-serif;
    }

    #zmmtg-root {
      display: none;
    }
  </style>
</head>

<body>
  <h1>Zoom Local SDK (5.1.0) Stability Test</h1>
  <p>Status: <span id="status">Loading resources...</span></p>
  <button id="joinBtn" disabled style="padding: 10px 20px; font-size: 16px; cursor: pointer;">Join Meeting</button>

  <!-- JS Dependencies -->
  <script src="/sdk/lib/vendor/react.min.js"></script>
  <script src="/sdk/lib/vendor/react-dom.min.js"></script>
  <script src="/sdk/lib/vendor/redux.min.js"></script>
  <script src="/sdk/lib/vendor/redux-thunk.min.js"></script>
  <script src="/sdk/lib/vendor/lodash.min.js"></script>
  <script src="/sdk/zoom-meeting-5.1.0.min.js"></script>

  <script>
    // Setup for Local Assets
    ZoomMtg.setZoomJSLib(window.location.origin + "/sdk/lib", "/av");
    ZoomMtg.preLoadWasm();
    ZoomMtg.prepareWebSDK();

    // Sample Code Configuration
    // Note: In real app, these shouldn't be hardcoded client-side, 
    // but for this test we match the sample structure using our server values.
    var authEndpoint = "/signature";
    var meetingNumber = "PASTE MEETING NUMBER";
    var passWord = "PASTE PASSWORD";
    var role = 0;
    var userName = "Test User";
    var userEmail = "";
    var registrantToken = "";
    var zakToken = "";
    var leaveUrl = "http://localhost:4000/index.html";

    function getSignature() {
      console.log("Fetching signature...");
      // We use GET here because our server is set up for GET
      // The sample uses POST, but we adapt to our working server.
      fetch(`${authEndpoint}?meetingNumber=${meetingNumber}&role=${role}`, {
        method: "GET",
        headers: { "Content-Type": "application/json" }
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Signature received", data);
          // Our server returns { signature, sdkKey }, the sample expects just signature or we pass both.
          // We need to pass the SDK Key to the join function if it's not in the signature (it is in sig, but join() likes it too)
          startMeeting(data.signature, data.sdkKey);
        })
        .catch((error) => {
          console.error("Signature Error:", error);
        });
    }

    function startMeeting(signature, sdkKey) {
      document.getElementById("zmmtg-root").style.display = "block";
      document.getElementById("status").innerText = "Initializing...";

      ZoomMtg.init({
        leaveUrl: leaveUrl,
        patchJsMedia: false, 
        leaveOnPageUnload: true,
        debug: false, 
        success: (success) => {
          console.log("Init Success", success);
          document.getElementById("status").innerText = "Joining...";

          ZoomMtg.join({
            signature: signature,
            meetingNumber: meetingNumber,
            passWord: passWord,
            userName: userName,
            userEmail: userEmail,
            sdkKey: sdkKey,
            tk: registrantToken,
            zak: zakToken,
            success: (success) => {
              console.log("Join Success", success);
              document.getElementById("status").innerText = "Joined!";
            },
            error: (error) => {
              console.error("Join Error", error);
              document.getElementById("status").innerText = "Join Error: " + JSON.stringify(error);
            },
          });
        },
        error: (error) => {
          console.error("Init Error", error);
          document.getElementById("status").innerText = "Init Error: " + JSON.stringify(error);
        },
      });
    }

    document.getElementById("joinBtn").addEventListener("click", getSignature);

    document.getElementById("joinBtn").disabled = false;
    document.getElementById("status").innerText = "Ready to Join";
  </script>
</body>

</html>